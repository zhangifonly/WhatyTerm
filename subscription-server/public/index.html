<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>WhatyTerm è®¢é˜…</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); min-height: 100vh; }
    .glass { background: rgba(255, 255, 255, 0.05); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.1); }
    .payment-modal { display: none; }
    .payment-modal.active { display: flex; }
    .qr-container { animation: pulse 2s infinite; }
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.8; }
    }
  </style>
</head>
<body class="text-gray-100">
  <div id="app" class="container mx-auto px-4 py-8 max-w-4xl">
    <!-- å¤´éƒ¨ -->
    <header class="flex justify-between items-center mb-12">
      <div>
        <h1 class="text-4xl font-bold mb-2 bg-gradient-to-r from-blue-400 to-purple-500 bg-clip-text text-transparent">
          WhatyTerm
        </h1>
        <p class="text-gray-400">AI æ™ºèƒ½ç»ˆç«¯ç®¡ç†å·¥å…·</p>
      </div>
      <div class="flex gap-3">
        <a href="#download" class="px-6 py-3 bg-green-600 hover:bg-green-700 rounded-lg font-medium">
          ä¸‹è½½å®¢æˆ·ç«¯
        </a>
        <a href="/user.html" class="px-6 py-3 bg-blue-600 hover:bg-blue-700 rounded-lg font-medium">
          ç™»å½• / ç”¨æˆ·ä¸­å¿ƒ
        </a>
      </div>
    </header>

    <!-- ä¸‹è½½åŒºåŸŸ -->
    <section id="download" class="glass rounded-xl p-6 mb-8">
      <h2 class="text-xl font-semibold mb-4">ä¸‹è½½ WhatyTerm <span class="text-sm text-gray-400 font-normal">v1.0.56</span></h2>
      <div class="grid md:grid-cols-3 gap-4">
        <a href="/whatyterm/v1.0.56/WhatyTerm-1.0.56.dmg" class="flex items-center gap-3 p-4 bg-gray-800/50 rounded-lg hover:bg-gray-700/50 transition">
          <span class="text-3xl">ğŸ</span>
          <div>
            <p class="font-medium">macOS (Intel)</p>
            <p class="text-sm text-gray-400">é€‚ç”¨äº Intel èŠ¯ç‰‡ Mac</p>
          </div>
        </a>
        <a href="/whatyterm/v1.0.56/WhatyTerm-1.0.56-arm64.dmg" class="flex items-center gap-3 p-4 bg-gray-800/50 rounded-lg hover:bg-gray-700/50 transition">
          <span class="text-3xl">ğŸ</span>
          <div>
            <p class="font-medium">macOS (Apple Silicon)</p>
            <p class="text-sm text-gray-400">é€‚ç”¨äº M1/M2/M3 èŠ¯ç‰‡ Mac</p>
          </div>
        </a>
        <a href="/whatyterm/v1.0.56/WhatyTerm%20Setup%201.0.56.exe" class="flex items-center gap-3 p-4 bg-gray-800/50 rounded-lg hover:bg-gray-700/50 transition">
          <span class="text-3xl">ğŸªŸ</span>
          <div>
            <p class="font-medium">Windows</p>
            <p class="text-sm text-gray-400">é€‚ç”¨äº Windows 10/11</p>
          </div>
        </a>
      </div>
    </section>

    <!-- æœºå™¨ ID æ˜¾ç¤º -->
    <div id="machine-info" class="glass rounded-xl p-6 mb-8 hidden">
      <h2 class="text-lg font-semibold mb-3">æ‚¨çš„æœºå™¨ ID</h2>
      <div class="flex items-center gap-3">
        <code id="machine-id" class="flex-1 bg-gray-800 px-4 py-2 rounded font-mono text-sm"></code>
        <button onclick="copyMachineId()" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded text-sm">
          å¤åˆ¶
        </button>
      </div>
      <p class="text-gray-500 text-sm mt-2">è´­ä¹°è®¢é˜…åï¼Œè¯·ä½¿ç”¨æ¿€æ´»ç åœ¨ WhatyTerm ä¸­æ¿€æ´»</p>
    </div>

    <!-- è®¢é˜…è®¡åˆ’ -->
    <section class="mb-12">
      <h2 class="text-2xl font-bold mb-6 text-center">é€‰æ‹©è®¢é˜…è®¡åˆ’</h2>
      <div id="plans" class="grid md:grid-cols-3 gap-6">
        <!-- è®¡åˆ’å¡ç‰‡å°†é€šè¿‡ JS åŠ¨æ€ç”Ÿæˆ -->
      </div>
    </section>

    <!-- æ¿€æ´»è¯´æ˜ -->
    <section class="glass rounded-xl p-6 mb-8">
      <h2 class="text-xl font-semibold mb-4">å¦‚ä½•æ¿€æ´»ï¼Ÿ</h2>
      <div class="space-y-4 text-gray-400">
        <div class="flex items-start gap-3">
          <span class="flex-shrink-0 w-8 h-8 bg-blue-600 rounded-full flex items-center justify-center text-white font-bold">1</span>
          <div>
            <p class="font-medium text-white">æ³¨å†Œ/ç™»å½•è´¦æˆ·</p>
            <p class="text-sm">å‰å¾€ <a href="/user.html" class="text-blue-400 hover:underline">ç”¨æˆ·ä¸­å¿ƒ</a> æ³¨å†Œæˆ–ç™»å½•æ‚¨çš„è´¦æˆ·</p>
          </div>
        </div>
        <div class="flex items-start gap-3">
          <span class="flex-shrink-0 w-8 h-8 bg-blue-600 rounded-full flex items-center justify-center text-white font-bold">2</span>
          <div>
            <p class="font-medium text-white">å…‘æ¢æ¿€æ´»ç </p>
            <p class="text-sm">åœ¨ç”¨æˆ·ä¸­å¿ƒè¾“å…¥æ¿€æ´»ç ï¼Œç»‘å®šåˆ°æ‚¨çš„è´¦æˆ·</p>
          </div>
        </div>
        <div class="flex items-start gap-3">
          <span class="flex-shrink-0 w-8 h-8 bg-blue-600 rounded-full flex items-center justify-center text-white font-bold">3</span>
          <div>
            <p class="font-medium text-white">åœ¨å®¢æˆ·ç«¯æ¿€æ´»</p>
            <p class="text-sm">åœ¨ WhatyTerm ä¸­ä½¿ç”¨é‚®ç®±å’Œå¯†ç ç™»å½•æ¿€æ´»</p>
          </div>
        </div>
      </div>
    </section>

    <!-- åŠŸèƒ½å¯¹æ¯” -->
    <section class="glass rounded-xl p-6 mb-8">
      <h2 class="text-xl font-semibold mb-4">åŠŸèƒ½å¯¹æ¯”</h2>
      <table class="w-full">
        <thead>
          <tr class="border-b border-gray-700">
            <th class="text-left py-3">åŠŸèƒ½</th>
            <th class="text-center py-3">å…è´¹ç‰ˆ</th>
            <th class="text-center py-3">è®¢é˜…ç‰ˆ</th>
          </tr>
        </thead>
        <tbody class="text-gray-400">
          <tr class="border-b border-gray-800">
            <td class="py-3">åŸºç¡€ç»ˆç«¯ç®¡ç†</td>
            <td class="text-center text-green-400">âœ“</td>
            <td class="text-center text-green-400">âœ“</td>
          </tr>
          <tr class="border-b border-gray-800">
            <td class="py-3">é»˜è®¤ç›‘æ§ç­–ç•¥</td>
            <td class="text-center text-green-400">âœ“</td>
            <td class="text-center text-green-400">âœ“</td>
          </tr>
          <tr class="border-b border-gray-800">
            <td class="py-3">15+ é«˜çº§ç›‘æ§ç­–ç•¥</td>
            <td class="text-center text-red-400">âœ—</td>
            <td class="text-center text-green-400">âœ“</td>
          </tr>
          <tr class="border-b border-gray-800">
            <td class="py-3">è®ºæ–‡å†™ä½œç­–ç•¥</td>
            <td class="text-center text-red-400">âœ—</td>
            <td class="text-center text-green-400">âœ“</td>
          </tr>
          <tr class="border-b border-gray-800">
            <td class="py-3">App å¼€å‘ç­–ç•¥</td>
            <td class="text-center text-red-400">âœ—</td>
            <td class="text-center text-green-400">âœ“</td>
          </tr>
          <tr class="border-b border-gray-800">
            <td class="py-3">æ•°æ®åˆ†æç­–ç•¥</td>
            <td class="text-center text-red-400">âœ—</td>
            <td class="text-center text-green-400">âœ“</td>
          </tr>
          <tr class="border-b border-gray-800">
            <td class="py-3">å®‰å…¨å®¡è®¡ç­–ç•¥</td>
            <td class="text-center text-red-400">âœ—</td>
            <td class="text-center text-green-400">âœ“</td>
          </tr>
          <tr>
            <td class="py-3">æŠ€æœ¯æ”¯æŒ</td>
            <td class="text-center">ç¤¾åŒº</td>
            <td class="text-center text-green-400">ä¼˜å…ˆ</td>
          </tr>
        </tbody>
      </table>
    </section>

    <!-- å¸¸è§é—®é¢˜ -->
    <section class="glass rounded-xl p-6">
      <h2 class="text-xl font-semibold mb-4">å¸¸è§é—®é¢˜</h2>
      <div class="space-y-4">
        <div>
          <h3 class="font-medium text-blue-400">å¦‚ä½•è·å–æ¿€æ´»ç ï¼Ÿ</h3>
          <p class="text-gray-400 text-sm mt-1">é€‰æ‹©è®¢é˜…è®¡åˆ’å¹¶å®Œæˆæ”¯ä»˜åï¼Œæ¿€æ´»ç å°†æ˜¾ç¤ºåœ¨æ”¯ä»˜æˆåŠŸé¡µé¢ã€‚</p>
        </div>
        <div>
          <h3 class="font-medium text-blue-400">å¯ä»¥åœ¨å¤šå°‘å°è®¾å¤‡ä¸Šä½¿ç”¨ï¼Ÿ</h3>
          <p class="text-gray-400 text-sm mt-1">ä¸ªäººç‰ˆæ”¯æŒ 1 å°è®¾å¤‡ï¼Œä¸“ä¸šç‰ˆæ”¯æŒ 5 å°ï¼Œä¼ä¸šç‰ˆä¸é™è®¾å¤‡æ•°ã€‚</p>
        </div>
        <div>
          <h3 class="font-medium text-blue-400">è®¢é˜…åˆ°æœŸåä¼šæ€æ ·ï¼Ÿ</h3>
          <p class="text-gray-400 text-sm mt-1">åˆ°æœŸåé«˜çº§ç›‘æ§ç­–ç•¥å°†ä¸å¯ç”¨ï¼Œä½†åŸºç¡€åŠŸèƒ½ä»å¯æ­£å¸¸ä½¿ç”¨ã€‚</p>
        </div>
        <div>
          <h3 class="font-medium text-blue-400">å¦‚ä½•æ›´æ¢è®¾å¤‡ï¼Ÿ</h3>
          <p class="text-gray-400 text-sm mt-1">ç™»å½• <a href="/user.html" class="text-blue-400 hover:underline">ç”¨æˆ·ä¸­å¿ƒ</a>ï¼Œåœ¨è®¾å¤‡ç®¡ç†ä¸­è§£ç»‘æ—§è®¾å¤‡ï¼Œç„¶ååœ¨æ–°è®¾å¤‡ä¸Šä½¿ç”¨é‚®ç®±å¯†ç é‡æ–°æ¿€æ´»ã€‚</p>
        </div>
      </div>
    </section>

    <!-- é¡µè„š -->
    <footer class="text-center text-gray-500 text-sm mt-12">
      <p>Â© 2025 WhatyTerm. All rights reserved.</p>
      <p class="mt-2">
        <a href="mailto:support@whaty.org" class="text-blue-400 hover:underline">support@whaty.org</a>
      </p>
    </footer>
  </div>

  <!-- æ”¯ä»˜å¼¹çª— -->
  <div id="payment-modal" class="payment-modal fixed inset-0 bg-black/70 items-center justify-center z-50">
    <div class="glass rounded-2xl p-8 max-w-md w-full mx-4">
      <div class="flex justify-between items-center mb-6">
        <h3 class="text-xl font-bold">å®Œæˆæ”¯ä»˜</h3>
        <button onclick="closePaymentModal()" class="text-gray-400 hover:text-white text-2xl">&times;</button>
      </div>

      <!-- è®¢å•ä¿¡æ¯ -->
      <div id="order-info" class="mb-6 p-4 bg-gray-800/50 rounded-lg">
        <div class="flex justify-between mb-2">
          <span class="text-gray-400">è®¢é˜…è®¡åˆ’</span>
          <span id="order-plan-name" class="font-medium"></span>
        </div>
        <div class="flex justify-between mb-2">
          <span class="text-gray-400">è®¢é˜…å‘¨æœŸ</span>
          <span id="order-period" class="font-medium"></span>
        </div>
        <div class="flex justify-between text-lg">
          <span class="text-gray-400">æ”¯ä»˜é‡‘é¢</span>
          <span id="order-amount" class="font-bold text-green-400"></span>
        </div>
      </div>

      <!-- é‚®ç®±è¾“å…¥ -->
      <div id="email-section" class="mb-6">
        <label class="block text-gray-400 text-sm mb-2">æ¥æ”¶è®¸å¯è¯çš„é‚®ç®± <span class="text-red-400">*</span></label>
        <input type="email" id="payment-email" required
          class="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-lg focus:outline-none focus:border-blue-500"
          placeholder="è¯·è¾“å…¥æ‚¨çš„é‚®ç®±åœ°å€">
        <p class="text-gray-500 text-xs mt-2">æ”¯ä»˜æˆåŠŸåï¼Œè®¸å¯è¯å°†å‘é€åˆ°æ­¤é‚®ç®±ï¼Œä¹Ÿå¯ç”¨äºç™»å½•ç”¨æˆ·ä¸­å¿ƒæŸ¥çœ‹è®¢å•</p>
      </div>

      <!-- æ”¯ä»˜æ–¹å¼é€‰æ‹© -->
      <div id="payment-methods" class="mb-6">
        <p class="text-gray-400 text-sm mb-3">é€‰æ‹©æ”¯ä»˜æ–¹å¼</p>
        <div class="grid grid-cols-2 gap-3">
          <button id="btn-alipay" onclick="selectPaymentMethod('alipay')"
            class="payment-method-btn p-4 rounded-lg border-2 border-gray-700 hover:border-blue-500 transition-colors">
            <div class="text-2xl mb-1">ğŸ’³</div>
            <div class="text-sm">æ”¯ä»˜å®</div>
          </button>
          <button id="btn-wechat" onclick="selectPaymentMethod('wechat')"
            class="payment-method-btn p-4 rounded-lg border-2 border-gray-700 hover:border-green-500 transition-colors">
            <div class="text-2xl mb-1">ğŸ’¬</div>
            <div class="text-sm">å¾®ä¿¡æ”¯ä»˜</div>
          </button>
        </div>
      </div>

      <!-- äºŒç»´ç åŒºåŸŸ -->
      <div id="qr-section" class="hidden">
        <div class="text-center mb-4">
          <p class="text-gray-400 text-sm mb-2">è¯·ä½¿ç”¨ <span id="payment-method-name"></span> æ‰«æäºŒç»´ç </p>
          <div class="qr-container inline-block p-4 bg-white rounded-lg">
            <img id="qr-code-img" src="" alt="æ”¯ä»˜äºŒç»´ç " class="w-48 h-48">
          </div>
        </div>
        <div class="text-center text-gray-400 text-sm">
          <p>è®¢å•å·: <span id="display-order-no"></span></p>
          <p class="mt-1">æ”¯ä»˜æœ‰æ•ˆæœŸ: <span id="expire-countdown"></span></p>
        </div>
        <div id="payment-status" class="mt-4 text-center hidden">
          <div class="inline-flex items-center gap-2 px-4 py-2 bg-yellow-900/50 text-yellow-400 rounded-lg">
            <svg class="animate-spin h-4 w-4" viewBox="0 0 24 24">
              <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" fill="none"></circle>
              <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <span>ç­‰å¾…æ”¯ä»˜...</span>
          </div>
        </div>
      </div>

      <!-- æ”¯ä»˜æˆåŠŸ -->
      <div id="payment-success" class="hidden text-center">
        <div class="text-6xl mb-4">âœ…</div>
        <h4 class="text-xl font-bold text-green-400 mb-2">æ”¯ä»˜æˆåŠŸï¼</h4>
        <p class="text-gray-400 mb-4">æ‚¨çš„è®¸å¯è¯å¯†é’¥ï¼š</p>
        <div class="p-4 bg-gray-800 rounded-lg mb-4">
          <code id="license-key" class="text-lg font-mono text-green-400 break-all"></code>
        </div>
        <button onclick="copyLicenseKey()" class="px-6 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg">
          å¤åˆ¶è®¸å¯è¯å¯†é’¥
        </button>
        <p class="text-gray-500 text-sm mt-4">è¯·åœ¨ WhatyTerm åº”ç”¨ä¸­ä½¿ç”¨æ­¤å¯†é’¥æ¿€æ´»è®¢é˜…</p>
      </div>
    </div>
  </div>

  <script>
    // çŠ¶æ€å˜é‡
    let currentPlan = null;
    let currentPeriod = 'yearly';
    let currentOrderNo = null;
    let statusCheckInterval = null;
    let countdownInterval = null;
    let expireTime = null;

    // è·å– URL å‚æ•°ä¸­çš„æœºå™¨ ID
    const urlParams = new URLSearchParams(window.location.search);
    const machineId = urlParams.get('machineId');

    if (machineId) {
      document.getElementById('machine-info').classList.remove('hidden');
      document.getElementById('machine-id').textContent = machineId;
    }

    // å¤åˆ¶æœºå™¨ ID
    function copyMachineId() {
      navigator.clipboard.writeText(machineId);
      alert('æœºå™¨ ID å·²å¤åˆ¶');
    }

    // åŠ è½½è®¢é˜…è®¡åˆ’
    async function loadPlans() {
      try {
        const res = await fetch('/api/plans');
        const plans = await res.json();

        const container = document.getElementById('plans');
        container.innerHTML = plans.map((plan, index) => `
          <div class="glass rounded-xl p-6 ${index === 1 ? 'ring-2 ring-blue-500' : ''}">
            ${index === 1 ? '<div class="text-blue-400 text-sm font-medium mb-2">æ¨è</div>' : ''}
            <h3 class="text-xl font-bold mb-2">${plan.name}</h3>
            <p class="text-gray-400 text-sm mb-4">${plan.description}</p>
            <div class="mb-4">
              <span class="text-3xl font-bold">Â¥${(plan.price_monthly / 100).toFixed(0)}</span>
              <span class="text-gray-400">/æœˆ</span>
            </div>
            <div class="text-gray-400 text-sm mb-4">
              æˆ– Â¥${(plan.price_yearly / 100).toFixed(0)}/å¹´ (çœ ${Math.round((1 - plan.price_yearly / (plan.price_monthly * 12)) * 100)}%)
            </div>
            <ul class="text-sm text-gray-400 mb-6 space-y-2">
              <li>âœ“ ${plan.max_devices === 999 ? 'ä¸é™' : plan.max_devices} å°è®¾å¤‡</li>
              <li>âœ“ æ‰€æœ‰é«˜çº§ç›‘æ§ç­–ç•¥</li>
              <li>âœ“ ${plan.id === 'enterprise' ? 'ä¸“å±' : plan.id === 'professional' ? 'ä¼˜å…ˆ' : 'é‚®ä»¶'}æŠ€æœ¯æ”¯æŒ</li>
            </ul>
            <div class="space-y-2">
              <button onclick="selectPlan('${plan.id}', 'yearly', ${plan.price_yearly}, '${plan.name}')"
                class="w-full py-3 ${index === 1 ? 'bg-blue-600 hover:bg-blue-700' : 'bg-gray-700 hover:bg-gray-600'} rounded-lg font-medium">
                å¹´ä»˜ Â¥${(plan.price_yearly / 100).toFixed(0)}
              </button>
              <button onclick="selectPlan('${plan.id}', 'monthly', ${plan.price_monthly}, '${plan.name}')"
                class="w-full py-2 text-sm text-gray-400 hover:text-white">
                æœˆä»˜ Â¥${(plan.price_monthly / 100).toFixed(0)}
              </button>
            </div>
          </div>
        `).join('');
      } catch (err) {
        console.error('åŠ è½½è®¡åˆ’å¤±è´¥:', err);
      }
    }

    // é€‰æ‹©è®¡åˆ’
    function selectPlan(planId, period, amount, planName) {
      currentPlan = planId;
      currentPeriod = period;

      // æ›´æ–°è®¢å•ä¿¡æ¯
      document.getElementById('order-plan-name').textContent = planName;
      document.getElementById('order-period').textContent = period === 'monthly' ? 'æœˆä»˜' : 'å¹´ä»˜';
      document.getElementById('order-amount').textContent = `Â¥${(amount / 100).toFixed(2)}`;

      // é‡ç½®æ”¯ä»˜çŠ¶æ€
      document.getElementById('qr-section').classList.add('hidden');
      document.getElementById('payment-success').classList.add('hidden');
      document.getElementById('payment-methods').classList.remove('hidden');
      document.querySelectorAll('.payment-method-btn').forEach(btn => {
        btn.classList.remove('border-blue-500', 'border-green-500');
        btn.classList.add('border-gray-700');
      });

      // æ˜¾ç¤ºå¼¹çª—
      document.getElementById('payment-modal').classList.add('active');

      // åŠ è½½å¯ç”¨æ”¯ä»˜æ–¹å¼
      loadPaymentMethods();
    }

    // åŠ è½½æ”¯ä»˜æ–¹å¼
    async function loadPaymentMethods() {
      try {
        const res = await fetch('/api/payment/methods');
        const methods = await res.json();

        // æ£€æŸ¥æ˜¯å¦æœ‰æ”¯ä»˜å®å’Œå¾®ä¿¡æ”¯ä»˜ï¼ˆåŒ…æ‹¬ CBB å’Œç›´è¿ï¼‰
        const hasAlipay = methods.find(m => m.id === 'alipay' || m.id === 'cbb_alipay');
        const hasWechat = methods.find(m => m.id === 'wechat' || m.id === 'cbb_wechat');

        document.getElementById('btn-alipay').style.display = hasAlipay ? 'block' : 'none';
        document.getElementById('btn-wechat').style.display = hasWechat ? 'block' : 'none';

        // ä¿å­˜æ”¯ä»˜æ–¹å¼æ˜ å°„
        window.paymentMethodMap = {};
        methods.forEach(m => {
          if (m.id === 'cbb_alipay' || m.id === 'alipay') {
            window.paymentMethodMap['alipay'] = m.id;
          }
          if (m.id === 'cbb_wechat' || m.id === 'wechat') {
            window.paymentMethodMap['wechat'] = m.id;
          }
        });

        if (methods.length === 0) {
          document.getElementById('payment-methods').innerHTML = `
            <div class="text-center text-yellow-400 p-4">
              <p>æ”¯ä»˜åŠŸèƒ½æš‚æœªé…ç½®</p>
              <p class="text-sm text-gray-400 mt-2">è¯·è”ç³» support@whaty.org è·å–æ¿€æ´»ç </p>
            </div>
          `;
        }
      } catch (err) {
        console.error('åŠ è½½æ”¯ä»˜æ–¹å¼å¤±è´¥:', err);
      }
    }

    // é€‰æ‹©æ”¯ä»˜æ–¹å¼
    async function selectPaymentMethod(method) {
      // éªŒè¯é‚®ç®±
      const emailInput = document.getElementById('payment-email');
      const email = emailInput.value.trim();
      if (!email) {
        emailInput.focus();
        emailInput.classList.add('border-red-500');
        alert('è¯·è¾“å…¥é‚®ç®±åœ°å€');
        return;
      }
      if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
        emailInput.focus();
        emailInput.classList.add('border-red-500');
        alert('è¯·è¾“å…¥æœ‰æ•ˆçš„é‚®ç®±åœ°å€');
        return;
      }
      emailInput.classList.remove('border-red-500');

      // æ›´æ–°æŒ‰é’®æ ·å¼
      document.querySelectorAll('.payment-method-btn').forEach(btn => {
        btn.classList.remove('border-blue-500', 'border-green-500');
        btn.classList.add('border-gray-700');
      });

      const btnId = method === 'alipay' ? 'btn-alipay' : 'btn-wechat';
      const borderColor = method === 'alipay' ? 'border-blue-500' : 'border-green-500';
      document.getElementById(btnId).classList.remove('border-gray-700');
      document.getElementById(btnId).classList.add(borderColor);

      // è·å–å®é™…çš„æ”¯ä»˜æ–¹å¼ IDï¼ˆå¯èƒ½æ˜¯ cbb_alipay æˆ– alipayï¼‰
      const actualMethod = window.paymentMethodMap[method] || method;

      // åˆ›å»ºè®¢å•
      try {
        const res = await fetch('/api/payment/create', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            planId: currentPlan,
            period: currentPeriod,
            paymentMethod: actualMethod,
            machineId: machineId || null,
            email: email
          })
        });

        const result = await res.json();

        if (!result.success) {
          alert(result.error || 'åˆ›å»ºè®¢å•å¤±è´¥');
          return;
        }

        currentOrderNo = result.orderNo;
        expireTime = Date.now() + (result.expireMinutes * 60 * 1000);

        // åˆ¤æ–­æ˜¯ CBB æ”¯ä»˜ï¼ˆè·³è½¬ï¼‰è¿˜æ˜¯ç›´è¿æ”¯ä»˜ï¼ˆäºŒç»´ç ï¼‰
        if (result.payUrl) {
          // CBB æ”¯ä»˜ï¼šè·³è½¬åˆ°æ”¯ä»˜é¡µé¢
          document.getElementById('payment-method-name').textContent = method === 'alipay' ? 'æ”¯ä»˜å®' : 'å¾®ä¿¡';
          document.getElementById('display-order-no').textContent = result.orderNo;

          // æ˜¾ç¤ºè·³è½¬æç¤º
          document.getElementById('qr-section').innerHTML = `
            <div class="text-center mb-4">
              <p class="text-gray-400 text-sm mb-4">å³å°†è·³è½¬åˆ° <span class="text-white font-medium">${method === 'alipay' ? 'æ”¯ä»˜å®' : 'å¾®ä¿¡'}</span> æ”¯ä»˜é¡µé¢</p>
              <a href="${result.payUrl}" target="_blank"
                class="inline-block px-8 py-3 bg-${method === 'alipay' ? 'blue' : 'green'}-600 hover:bg-${method === 'alipay' ? 'blue' : 'green'}-700 rounded-lg font-medium">
                ç«‹å³æ”¯ä»˜
              </a>
              <p class="text-gray-500 text-sm mt-4">æ”¯ä»˜å®Œæˆåè¯·è¿”å›æ­¤é¡µé¢</p>
            </div>
            <div class="text-center text-gray-400 text-sm">
              <p>è®¢å•å·: <span id="display-order-no">${result.orderNo}</span></p>
              <p class="mt-1">æ”¯ä»˜æœ‰æ•ˆæœŸ: <span id="expire-countdown"></span></p>
            </div>
          `;
          document.getElementById('qr-section').classList.remove('hidden');
          document.getElementById('payment-status').classList.remove('hidden');

          // è‡ªåŠ¨æ‰“å¼€æ”¯ä»˜é¡µé¢
          window.open(result.payUrl, '_blank');

          // å¼€å§‹å€’è®¡æ—¶å’ŒçŠ¶æ€æ£€æŸ¥
          startCountdown();
          startStatusCheck();
        } else if (result.qrCodeImage) {
          // ç›´è¿æ”¯ä»˜ï¼šæ˜¾ç¤ºäºŒç»´ç 
          document.getElementById('qr-section').innerHTML = `
            <div class="text-center mb-4">
              <p class="text-gray-400 text-sm mb-2">è¯·ä½¿ç”¨ <span id="payment-method-name">${method === 'alipay' ? 'æ”¯ä»˜å®' : 'å¾®ä¿¡'}</span> æ‰«æäºŒç»´ç </p>
              <div class="qr-container inline-block p-4 bg-white rounded-lg">
                <img id="qr-code-img" src="${result.qrCodeImage}" alt="æ”¯ä»˜äºŒç»´ç " class="w-48 h-48">
              </div>
            </div>
            <div class="text-center text-gray-400 text-sm">
              <p>è®¢å•å·: <span id="display-order-no">${result.orderNo}</span></p>
              <p class="mt-1">æ”¯ä»˜æœ‰æ•ˆæœŸ: <span id="expire-countdown"></span></p>
            </div>
          `;
          document.getElementById('qr-section').classList.remove('hidden');
          document.getElementById('payment-status').classList.remove('hidden');

          // å¼€å§‹å€’è®¡æ—¶
          startCountdown();

          // å¼€å§‹è½®è¯¢æ”¯ä»˜çŠ¶æ€
          startStatusCheck();
        }
      } catch (err) {
        console.error('åˆ›å»ºè®¢å•å¤±è´¥:', err);
        alert('åˆ›å»ºè®¢å•å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
      }
    }

    // å¼€å§‹å€’è®¡æ—¶
    function startCountdown() {
      if (countdownInterval) clearInterval(countdownInterval);

      function updateCountdown() {
        const remaining = Math.max(0, expireTime - Date.now());
        const minutes = Math.floor(remaining / 60000);
        const seconds = Math.floor((remaining % 60000) / 1000);
        document.getElementById('expire-countdown').textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;

        if (remaining <= 0) {
          clearInterval(countdownInterval);
          clearInterval(statusCheckInterval);
          alert('è®¢å•å·²è¿‡æœŸï¼Œè¯·é‡æ–°ä¸‹å•');
          closePaymentModal();
        }
      }

      updateCountdown();
      countdownInterval = setInterval(updateCountdown, 1000);
    }

    // å¼€å§‹è½®è¯¢æ”¯ä»˜çŠ¶æ€
    function startStatusCheck() {
      if (statusCheckInterval) clearInterval(statusCheckInterval);

      statusCheckInterval = setInterval(async () => {
        try {
          const res = await fetch(`/api/payment/status/${currentOrderNo}`);
          const result = await res.json();

          if (result.status === 'paid') {
            clearInterval(statusCheckInterval);
            clearInterval(countdownInterval);
            showPaymentSuccess(result.license);
          }
        } catch (err) {
          console.error('æŸ¥è¯¢çŠ¶æ€å¤±è´¥:', err);
        }
      }, 3000);
    }

    // æ˜¾ç¤ºæ”¯ä»˜æˆåŠŸ
    function showPaymentSuccess(license) {
      document.getElementById('qr-section').classList.add('hidden');
      document.getElementById('payment-methods').classList.add('hidden');
      document.getElementById('payment-success').classList.remove('hidden');
      document.getElementById('license-key').textContent = license.key;
    }

    // å¤åˆ¶è®¸å¯è¯å¯†é’¥
    function copyLicenseKey() {
      const key = document.getElementById('license-key').textContent;
      navigator.clipboard.writeText(key);
      alert('è®¸å¯è¯å¯†é’¥å·²å¤åˆ¶');
    }

    // å…³é—­æ”¯ä»˜å¼¹çª—
    function closePaymentModal() {
      document.getElementById('payment-modal').classList.remove('active');
      if (statusCheckInterval) clearInterval(statusCheckInterval);
      if (countdownInterval) clearInterval(countdownInterval);
      currentOrderNo = null;
    }

    // åˆå§‹åŒ–
    loadPlans();
  </script>
</body>
</html>
