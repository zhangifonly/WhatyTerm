# 密码重置功能测试计划

## 测试环境
- 订阅服务器: http://localhost:3100
- 测试用户: test@example.com
- 测试日期: 2026-01-18

## 测试用例

### 1. 忘记密码 API 测试

#### 1.1 已注册邮箱请求重置
- [x] 请求 `/api/auth/forgot-password`，传入已注册邮箱
- [x] 验证返回 `success: true`
- [x] 验证返回包含 `resetToken` 和 `resetUrl`（开发模式）
- [x] 验证数据库中 `reset_token` 和 `reset_token_expires` 已更新

#### 1.2 未注册邮箱请求重置
- [x] 请求 `/api/auth/forgot-password`，传入未注册邮箱
- [x] 验证返回 `success: true`（防枚举攻击）
- [x] 验证返回消息与已注册邮箱相同

#### 1.3 空邮箱请求
- [x] 请求 `/api/auth/forgot-password`，不传邮箱
- [x] 验证返回错误 400

### 2. 验证令牌 API 测试

#### 2.1 有效令牌验证
- [x] 请求 `/api/auth/verify-reset-token`，传入有效令牌
- [x] 验证返回 `valid: true`
- [x] 验证返回隐藏的邮箱格式（如 `te***@example.com`）

#### 2.2 无效令牌验证
- [x] 请求 `/api/auth/verify-reset-token`，传入无效令牌
- [x] 验证返回 `valid: false`

#### 2.3 过期令牌验证
- [x] 手动设置数据库中令牌过期时间为过去
- [x] 请求验证 API
- [x] 验证返回 `valid: false`

#### 2.4 空令牌验证
- [x] 请求 `/api/auth/verify-reset-token`，不传令牌
- [x] 验证返回错误 400

### 3. 重置密码 API 测试

#### 3.1 有效令牌重置密码
- [x] 请求 `/api/auth/reset-password`，传入有效令牌和新密码
- [x] 验证返回 `success: true`
- [x] 验证使用新密码可以登录
- [x] 验证旧密码无法登录

#### 3.2 令牌使用后失效
- [x] 使用令牌重置密码后
- [x] 再次使用同一令牌重置
- [x] 验证返回错误（令牌已失效）

#### 3.3 密码长度验证
- [x] 请求重置密码，新密码少于 6 位
- [x] 验证返回错误 400

#### 3.4 缺少参数
- [x] 请求重置密码，缺少令牌
- [x] 验证返回错误 400
- [x] 请求重置密码，缺少新密码
- [x] 验证返回错误 400

### 4. 前端页面测试

#### 4.1 用户中心忘记密码链接
- [x] 访问 `/user.html`
- [x] 验证登录表单下方有"忘记密码？"链接
- [x] 验证链接指向 `/reset-password.html`

#### 4.2 密码重置页面 - 请求重置
- [x] 访问 `/reset-password.html`（无 token 参数）
- [x] 验证显示"忘记密码"表单
- [x] 验证包含邮箱输入框和提交按钮

#### 4.3 密码重置页面 - 重置密码
- [x] 验证页面包含"设置新密码"表单
- [x] 验证包含新密码和确认密码输入框
- [x] 验证包含成功提示区域

#### 4.4 密码重置页面 - 无效令牌
- [x] 验证页面包含"链接无效或已过期"提示区域
- [x] 验证包含重新申请链接

### 5. 客户端组件测试

#### 5.1 订阅管理组件忘记密码链接
- [x] 验证 SubscriptionManager.jsx 包含"忘记密码？"链接
- [x] 验证链接指向正确的重置页面

### 6. 安全性测试

#### 6.1 令牌安全性
- [x] 验证令牌长度足够（64 字符十六进制 = 32 字节）
- [x] 验证令牌随机性（多次请求生成不同令牌）
- [x] 验证令牌格式正确（十六进制）

#### 6.2 令牌有效期
- [x] 验证令牌有效期为 1 小时（3600 秒）
- [x] 验证 API 返回正确的有效期信息

#### 6.3 邮箱枚举防护
- [x] 验证已注册和未注册邮箱返回相同消息
- [x] 验证响应时间相近（防时序攻击）
- [x] 验证未注册邮箱不返回 resetToken

---

## 测试结果汇总

| 测试类别 | 通过 | 失败 | 跳过 |
|---------|------|------|------|
| 忘记密码 API | 3 | 0 | 0 |
| 验证令牌 API | 4 | 0 | 0 |
| 重置密码 API | 4 | 0 | 0 |
| 前端页面 | 4 | 0 | 0 |
| 客户端组件 | 1 | 0 | 0 |
| 安全性 | 3 | 0 | 0 |
| **总计** | **19** | **0** | **0** |

## Bug 记录

| Bug ID | 描述 | 状态 | 修复方案 |
|--------|------|------|----------|
| - | 无 Bug 发现 | - | - |

## 测试结论

✅ **所有测试用例通过**

密码重置功能已完整实现，包括：
1. 后端 API（忘记密码、验证令牌、重置密码）
2. 前端页面（reset-password.html）
3. 用户中心和客户端组件的忘记密码链接
4. 安全性措施（令牌安全、有效期、邮箱枚举防护）
