# WebTmux 未来规划

## 1. CC Switch Proxy 功能

### 功能描述
将 CC Switch 桌面版的 Proxy 功能移植到 WebTmux 后端，实现 API 请求代理。

### 功能点
| 功能 | 描述 |
|------|------|
| **热切换** | 不重启 Claude Code 即可切换 API 供应商 |
| **自动故障转移** | 某个供应商 API 失败时自动切换到备用供应商 |
| **请求统计** | 统计 token 用量、API 调用次数、成本等 |

### 当前状态
- **决定**：暂不实现
- **日期**：2025-12-13
- **理由**：
  1. 当前"选择供应商 → 重启会话"模式已够用
  2. 开发任务中途切换供应商需求少
  3. API 故障不是常见情况
  4. 实现成本较高（HTTP/HTTPS 代理、证书处理、故障检测）

### 触发条件
以下情况出现时考虑实现：
1. 需要精确的 token/成本统计功能
2. 用户对高可用性有明确需求（多供应商自动切换）
3. 用户反馈切换供应商流程太麻烦

### 技术方案概要
```
┌─────────────────────────────────────────────────────────┐
│                 Node.js 后端服务器                       │
│  ┌─────────────────────────────────────────────────┐   │
│  │  Proxy 服务器 (新增)                             │   │
│  │  - 监听本地端口（如 3100）                       │   │
│  │  - 拦截 Claude Code 的 API 请求                 │   │
│  │  - 根据当前供应商配置转发请求                    │   │
│  │  - 记录请求/响应用于统计                        │   │
│  │  - 故障检测 + 自动切换                          │   │
│  └─────────────────────────────────────────────────┘   │
└───────────────────────────────────────────────────────────┘
            │
            ▼
┌─────────────────────────────────────────────────────────┐
│  Claude Code 进程                                       │
│  ANTHROPIC_BASE_URL=http://localhost:3100              │
└─────────────────────────────────────────────────────────┘
```

### 实现步骤（供未来参考）
1. 在后端添加 HTTP 代理服务器模块
2. 实现请求转发逻辑（读取当前供应商配置）
3. 添加请求/响应日志记录
4. 实现故障检测和自动切换逻辑
5. 修改 SessionManager，启动 Claude Code 时设置代理环境变量
6. 前端添加代理状态显示和统计面板

---

## 2. Claude Code 请求伪装（待实现）

### 功能描述
当 AIEngine 调用 CC Switch 中的 Claude 类型供应商时，自动伪装成 Claude Code 请求，以绑过 Claude Relay Service 的客户端限制。

### 当前状态
- **决定**：需要实现
- **日期**：2025-12-14
- **优先级**：高
- **原因**：许多 Claude Relay Service 设置了 Claude Code Only 限制，不伪装会返回 403 错误

### 实现要点

1. **检测条件**：供应商 `app_type = 'claude'` 且 API URL 包含 `/api/v1/messages`

2. **伪装请求头**：
   - `User-Agent: claude-cli/1.0.119 (external, cli)`
   - `x-app: cli`
   - `anthropic-beta: claude-code-20250219,oauth-2025-04-20,...`
   - `anthropic-version: 2023-06-01`

3. **伪装请求体**：
   - `system` 字段添加 Claude Code 标识
   - `metadata.user_id` 使用正确格式

### 参考代码
- 测试脚本：`test-claude-code-fake.js`（已验证可用）
- 实现位置：`server/services/AIEngine.js` 的 `_callApi` 方法

### 验证结果
- `88code.org`：✅ 通过
- `crs.whaty.org`：✅ 通过

---

## 3. （预留位置）

*后续规划功能在此添加*
